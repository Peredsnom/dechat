<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DeChat Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .messages { height: 300px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; }
        .message { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .sent { background: #007bff; color: white; margin-left: 50px; }
        .received { background: #e9ecef; margin-right: 50px; }
        input, button { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ DeChat - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        
        <div class="section">
            <h3>üìä –°—Ç–∞—Ç—É—Å</h3>
            <div id="serverStatus" class="status offline">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...</div>
            <div id="dbStatus" class="status offline">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î...</div>
        </div>

        <div class="section">
            <h3>üîê –í—Ö–æ–¥</h3>
            <input type="text" id="username" placeholder="Username" value="testuser1">
            <input type="email" id="email" placeholder="Email" value="test1@example.com">
            <input type="password" id="password" placeholder="Password" value="password123">
            <button type="button" onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="login()">–í—Ö–æ–¥</button>
            <div id="userInfo" style="display: none;">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="currentUser"></span>
                <button onclick="logout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <div class="section">
            <h3>üí¨ –ß–∞—Ç—ã</h3>
            <div class="grid">
                <div>
                    <h4>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h4>
                    <div id="usersList">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div>
                    <h4 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h4>
                    <div class="section">
                        <button id="callBtn" onclick="startCall()">üìû –ó–≤–æ–Ω–æ–∫</button>
                        <button id="hangupBtn" onclick="hangupCall()" style="display:none">üì¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                        <span id="callStatus">–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º</span>
                    </div>
                    <div id="messages" class="messages">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendDirectMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üîß –õ–æ–≥</h3>
            <div id="log" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket, currentUser = null, currentToken = '', currentChatId = null;
        let currentPeer = null;

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            document.getElementById('log').innerHTML = `[${time}] ${msg}<br>` + document.getElementById('log').innerHTML;
            console.log(msg);
        }

        function initSocket() {
            socket = io();
            socket.on('connect', () => {
                log('‚úÖ Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω');
                document.getElementById('serverStatus').className = 'status online';
                document.getElementById('serverStatus').textContent = '‚úÖ –°–µ—Ä–≤–µ—Ä –æ–Ω–ª–∞–π–Ω';
                // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                if (currentUser?.username) {
                    try { socket.emit('user_joined', { username: currentUser.username }); } catch (e) {}
                }
            });
            socket.on('disconnect', () => {
                log('‚ùå Socket.IO –æ—Ç–∫–ª—é—á–µ–Ω');
                document.getElementById('serverStatus').className = 'status offline';
                document.getElementById('serverStatus').textContent = '‚ùå –°–µ—Ä–≤–µ—Ä –æ—Ñ—Ñ–ª–∞–π–Ω';
            });
            socket.on('new_message', (data) => {
                // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1:1: {sender, recipient, text, timestamp}
                if (!data?.chatId && data?.text && data?.sender) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—Ö–æ–¥—è—â–∏–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—ë —ç—Ö–æ
                    if (data.sender === currentPeer && data.sender !== currentUser?.username) {
                        displayDirectMessage({ sender: data.sender, text: data.text, timestamp: data.timestamp || Date.now() });
                    }
                    return;
                }
                // –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç
                if (data.chatId === currentChatId) displayMessage(data);
            });
            socket.on('users_list', (users) => {
                renderUsersList(users);
            });
            socket.on('incoming_call', (data) => {
                log('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ' + data.callerId);
                showIncomingCallDialog(data.callerId);
            });
            socket.on('call_answered', (data) => {
                if (data.answer === 'accepted') {
                    document.getElementById('callStatus').textContent = '–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ';
                    log('‚úÖ –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º');
                } else if (data.answer === 'declined') {
                    hangupCall();
                    log('‚ùå –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º');
                }
            });
        }

        async function checkDB() {
            try {
                const response = await fetch('/health');
                await response.json();
                document.getElementById('dbStatus').className = 'status online';
                document.getElementById('dbStatus').textContent = '‚úÖ MongoDB Atlas –ø–æ–¥–∫–ª—é—á–µ–Ω–∞';
                log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω');
            } catch (error) {
                document.getElementById('dbStatus').className = 'status offline';
                document.getElementById('dbStatus').textContent = '‚ùå –û—à–∏–±–∫–∞ –ë–î';
                log('‚ùå –û—à–∏–±–∫–∞ –ë–î: ' + error.message);
            }
        }

        async function registerUser() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!username || !email || !password) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            if (username.length < 3) {
                alert('‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            if (password.length < 6) {
                alert('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            log(`üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username} (${email})`);

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.');
                    log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ' + JSON.stringify(data.user, null, 2));
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    document.getElementById('username').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                } else {
                    const errorMsg = data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + errorMsg);
                    log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                alert('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000');
                log('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            }
        }

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!email || !password) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            log(`üö™ –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: ${email}`);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    currentToken = data.token;
                    currentUser = data.user;
                    showUser();
                    // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –∏ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω
                    try { socket?.emit('user_joined', { username: currentUser.username }); } catch (e) {}
                    log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª: ' + JSON.stringify(data.user, null, 2));
                } else {
                    const errorMsg = data.error || data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + errorMsg);
                    log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + JSON.stringify(data, null, 2));

                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (data.error && data.error.includes('Invalid email or password')) {
                        setTimeout(() => {
                            alert('üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:\n1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω\n2. Email –∏ –ø–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ\n3. –°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MongoDB');
                        }, 500);
                    }
                }
            } catch (error) {
                alert('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000');
                log('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ' + error.message);
            }
        }

        function showUser() {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser.username;
        }

        function logout() {
            currentToken = '';
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('usersList').innerHTML = '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
            log('üëã –í—ã—Ö–æ–¥');
        }

        async function createChat() {
            if (!currentToken) { alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'); return; }
            
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:');
            if (!name) return;
            
            try {
                const response = await fetch('/api/chat/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ name, participants: [currentUser._id] })
                });
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω!');
                    updateChatsList();
                    log('‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω: ' + name);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function createChatWithEmail() {
            if (!currentToken) { alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'); return; }
            const email = prompt('Email –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:');
            if (!email) return;
            try {
                const userResp = await fetch(`/api/auth/users?email=${encodeURIComponent(email)}`);
                const userData = await userResp.json();
                if (!userResp.ok) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: ' + (userData.error || '')); return;
                }
                const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', `–ß–∞—Ç —Å ${userData.user.username}`) || `–ß–∞—Ç —Å ${userData.user.username}`;
                const response = await fetch('/api/chat/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ name, participants: [userData.user._id] })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω!');
                    updateChatsList();
                    log('‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω: ' + name);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function renderUsersList(users) {
            const list = document.getElementById('usersList');
            if (!list) return;
            list.innerHTML = '';
            const unique = new Map();
            (users || []).forEach(u => { if (u?.username) unique.set(u.username, u); });
            unique.forEach((u, name) => {
                if (!currentUser || name === currentUser.username) return;
                const div = document.createElement('div');
                div.style.cssText = 'padding: 8px; border: 1px solid #ccc; margin: 5px 0; cursor: pointer; display:flex; justify-content:space-between;';
                div.onclick = () => selectPeer(name);
                const status = u.online ? 'üü¢' : '‚ö™';
                div.innerHTML = `<span>${name}</span><span>${status}</span>`;
                list.appendChild(div);
            });
        }

        function selectPeer(username) {
            currentPeer = username;
            document.getElementById('chatTitle').textContent = `üí¨ ${username}`;
            document.getElementById('messages').innerHTML = '';
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ 1:1
            loadDirectHistory(username);
        }

        async function loadDirectHistory(peer) {
            try {
                const url = `${window.location.origin}/api/direct/messages?me=${encodeURIComponent(currentUser.username)}&peer=${encodeURIComponent(peer)}&limit=200`;
                const resp = await fetch(url);
                const data = await resp.json();
                if (resp.ok && Array.isArray(data.messages)) {
                    data.messages.forEach(m => displayDirectMessage({ sender: m.sender, text: m.text, timestamp: m.timestamp }));
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + e.message);
            }
        }

        function selectChat(chatId, chatName) {
            currentChatId = chatId;
            document.getElementById('chatTitle').textContent = `üí¨ ${chatName}`;
            socket?.emit('join_chat', chatId);
            loadMessages(chatId);
            log(`üë• –í—ã–±—Ä–∞–Ω —á–∞—Ç: ${chatName}`);
        }

        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chat/chats/${chatId}/messages`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();
                
                const messagesEl = document.getElementById('messages');
                messagesEl.innerHTML = '';
                
                if (data.messages?.length > 0) {
                    data.messages.forEach(msg => displayMessage(msg));
                } else {
                    messagesEl.innerHTML = '<p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + error.message);
            }
        }

        function displayMessage(message) {
            const messagesEl = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${message.senderId === currentUser._id ? 'sent' : 'received'}`;
            div.innerHTML = `
                <strong>${message.senderId === currentUser._id ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'}:</strong><br>
                ${message.encryptedContent}<br>
                <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
            `;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function sendDirectMessage() {
            if (!currentPeer) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞'); return; }
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            const payload = {
                sender: currentUser.username,
                recipient: currentPeer,
                text,
                timestamp: Date.now()
            };
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ä–∞–∑—É –ª–æ–∫–∞–ª—å–Ω–æ (—ç—Ö–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–∂–µ –ø—Ä–∏–¥–µ—Ç, –Ω–æ –º—ã —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é)
            displayDirectMessage({ sender: currentUser.username, text, timestamp: payload.timestamp });
            socket?.emit('send_message', payload);
            input.value = '';
        }

        function displayDirectMessage({ sender, text, timestamp }) {
            const messagesEl = document.getElementById('messages');
            const div = document.createElement('div');
            const isOwn = sender === currentUser.username;
            div.className = `message ${isOwn ? 'sent' : 'received'}`;
            div.innerHTML = `
                <strong>${isOwn ? '–í—ã' : sender}:</strong><br>
                ${text}<br>
                <small>${new Date(timestamp).toLocaleTimeString()}</small>
            `;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendDirectMessage();
            }
        }

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        async function startCall() {
            if (!currentPeer) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞'); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                log('üìû –û—Ç–ø—Ä–∞–≤–ª—è—é voice_call_request –∫ ' + currentPeer);
                socket?.emit('voice_call_request', {
                    targetUserId: currentPeer,
                    callerId: currentUser.username,
                    offer: 'fake_offer'
                });
                document.getElementById('callBtn').style.display = 'none';
                document.getElementById('hangupBtn').style.display = 'inline';
                document.getElementById('callStatus').textContent = '–ó–≤–æ–Ω–∏–º...';
                log('üìû –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
                log('‚ùå –û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞: ' + error.message);
            }
        }

        function answerCall() {
            document.getElementById('callStatus').textContent = '–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ';
            log('üìû –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç');
        }

        function hangupCall() {
            log('üîß hangupCall() –≤—ã–∑–≤–∞–Ω');
            document.getElementById('callBtn').style.display = 'inline';
            document.getElementById('hangupBtn').style.display = 'none';
            document.getElementById('callStatus').textContent = '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º';
            log('üì¥ –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        function showIncomingCallDialog(callerId) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 9999; display: flex; 
                align-items: center; justify-content: center;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px;">
                    <h2>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h2>
                    <p style="margin: 20px 0; font-size: 18px;">–æ—Ç <strong>${callerId}</strong></p>
                    <button onclick="acceptCall('${callerId}')" style="background: #25d366; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 25px; font-size: 16px; cursor: pointer;">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                    <button onclick="declineCall('${callerId}')" style="background: #ff4444; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 25px; font-size: 16px; cursor: pointer;">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            `;
            modal.id = 'incomingCallModal';
            document.body.appendChild(modal);
        }

        function acceptCall(callerId) {
            document.getElementById('incomingCallModal')?.remove();
            answerCall();
            socket.emit('voice_call_answer', { callerId, answer: 'accepted' });
            log('‚úÖ –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç');
        }

        function declineCall(callerId) {
            document.getElementById('incomingCallModal')?.remove();
            socket.emit('voice_call_answer', { callerId, answer: 'declined' });
            log('üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            log('üöÄ –ó–∞–ø—É—Å–∫ DeChat...');
            initSocket();
            checkDB();
            setInterval(checkDB, 30000);
        };
    </script>
</body>
</html>
