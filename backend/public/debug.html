<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DeChat Debug</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß DeChat Debug Console</h1>

        <div class="section">
            <h3>üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <div id="serverStatus" class="status warning">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
            <button onclick="checkServer()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
        </div>

        <div class="section">
            <h3>üóÑÔ∏è –°—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
            <div id="dbStatus" class="status warning">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
            <button onclick="checkDatabase()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î</button>
        </div>

        <div class="section">
            <h3>üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <input type="text" id="regUsername" placeholder="Username" value="testuser">
            <input type="email" id="regEmail" placeholder="Email" value="test@example.com">
            <input type="password" id="regPassword" placeholder="Password" value="password123">
            <button onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="regResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üö™ –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
            <input type="password" id="loginPassword" placeholder="Password" value="password123">
            <button onclick="loginUser()">–í–æ–π—Ç–∏</button>
            <div id="loginResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</h3>
            <button onclick="testHealth()">Health Check</button>
            <button onclick="testAuth()">Test Auth</button>
            <button onclick="testChat()">Test Chat</button>
            <div id="apiResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üìù –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div id="log" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        let authToken = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        async function checkServer() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...');
            const statusEl = document.getElementById('serverStatus');

            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + data.status;
                    log('‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                } else {
                    throw new Error('Server error: ' + response.status);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + error.message;
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + error.message);
            }
        }

        async function checkDatabase() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
            const statusEl = document.getElementById('dbStatus');

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'db_test_' + Date.now(),
                        email: 'db_test_' + Date.now() + '@example.com',
                        password: 'test123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω';
                    log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    const error = await response.text();
                    throw new Error('Database error: ' + error);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message;
                log('‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        async function registerUser() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            log(`üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}`);

            const resultEl = document.getElementById('regResult');
            resultEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.textContent = '‚úÖ –£–°–ü–ï–•:\n' + JSON.stringify(data, null, 2);
                    log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                    if (data.token) {
                        authToken = data.token;
                        log('üîë –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω');
                    }
                } else {
                    resultEl.textContent = '‚ùå –û–®–ò–ë–ö–ê:\n' + JSON.stringify(data, null, 2);
                    log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + JSON.stringify(data));
                }
            } catch (error) {
                resultEl.textContent = '‚ùå –°–ï–¢–ï–í–ê–Ø –û–®–ò–ë–ö–ê:\n' + error.message;
                log('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            }
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            log(`üö™ –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: ${email}`);

            const resultEl = document.getElementById('loginResult');
            resultEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.textContent = '‚úÖ –£–°–ü–ï–•:\n' + JSON.stringify(data, null, 2);
                    log('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    if (data.token) {
                        authToken = data.token;
                        log('üîë –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω');
                    }
                } else {
                    resultEl.textContent = '‚ùå –û–®–ò–ë–ö–ê:\n' + JSON.stringify(data, null, 2);
                    log('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + JSON.stringify(data));
                }
            } catch (error) {
                resultEl.textContent = '‚ùå –°–ï–¢–ï–í–ê–Ø –û–®–ò–ë–ö–ê:\n' + error.message;
                log('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ' + error.message);
            }
        }

        async function testHealth() {
            const resultEl = document.getElementById('apiResult');
            resultEl.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /health...';

            try {
                const response = await fetch('/health');
                const data = await response.json();
                resultEl.textContent = '‚úÖ Health Check:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                resultEl.textContent = '‚ùå –û—à–∏–±–∫–∞:\n' + error.message;
            }
        }

        async function testAuth() {
            const resultEl = document.getElementById('apiResult');
            resultEl.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/auth/profile...';

            try {
                const response = await fetch('/api/auth/profile', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                resultEl.textContent = '‚úÖ Auth Test:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                resultEl.textContent = '‚ùå –û—à–∏–±–∫–∞:\n' + error.message;
            }
        }

        async function testChat() {
            const resultEl = document.getElementById('apiResult');
            resultEl.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/chat/chats...';

            try {
                const response = await fetch('/api/chat/chats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                resultEl.textContent = '‚úÖ Chat Test:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                resultEl.textContent = '‚ùå –û—à–∏–±–∫–∞:\n' + error.message;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('üöÄ DeChat Debug Console –∑–∞–ø—É—â–µ–Ω');
            setTimeout(() => {
                checkServer();
                checkDatabase();
            }, 1000);
        };
    </script>
</body>
</html>
